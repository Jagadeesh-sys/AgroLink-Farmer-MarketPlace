package com.agrolink.servlets;

import com.agrolink.dao.CropDAO;
import com.agrolink.model.Crop;
import com.agrolink.util.CloudinaryConfig;
import com.cloudinary.Cloudinary;
import com.cloudinary.utils.ObjectUtils;

import javax.servlet.ServletException;
import javax.servlet.annotation.MultipartConfig;
import javax.servlet.http.*;
import java.io.InputStream;
import java.util.Collection;
import java.util.Map;

@MultipartConfig(
        fileSizeThreshold = 1024 * 1024,
        maxFileSize = 1024 * 1024 * 5,
        maxRequestSize = 1024 * 1024 * 20
)
public class SellingCropServlet extends BaseServlet {

    @Override
    protected void doPost(HttpServletRequest request, HttpServletResponse response)
            throws ServletException {

        try {
            setCors(request, response);
            response.setContentType("application/json");
            response.setCharacterEncoding("UTF-8");

            // âœ… Cloudinary instance (from CLOUDINARY_URL env)
            Cloudinary cloudinary = CloudinaryConfig.getInstance();

            String farmerId = request.getParameter("farmerId");
            String cropName = request.getParameter("cropName");
            String category = request.getParameter("category");
            String quantity = request.getParameter("quantity");
            String price = request.getParameter("price");
            String deliveryTime = request.getParameter("deliveryTime");
            String grade = request.getParameter("grade");
            String description = request.getParameter("description");

            StringBuilder imageUrls = new StringBuilder();

            // ðŸ”¹ Upload images to Cloudinary
            Collection<Part> parts = request.getParts();
            for (Part part : parts) {

                if (!"images".equals(part.getName())) continue;
                if (part.getSize() == 0) continue;

                try (InputStream is = part.getInputStream()) {

                    Map<?, ?> uploadResult = cloudinary.uploader().upload(
                            is,
                            ObjectUtils.asMap(
                                    "folder", "agrolink/crops"
                            )
                    );

                    String secureUrl =
                            uploadResult.get("secure_url").toString();

                    imageUrls.append(secureUrl).append(",");
                }
            }

            CropDAO dao = new CropDAO();
            Crop crop = new Crop();

            String cropId = dao.generateCropId(farmerId);

            crop.setCropId(cropId);
            crop.setFarmerId(farmerId);
            crop.setCropName(cropName);
            crop.setCategory(category);
            crop.setQuantity(quantity);
            crop.setPrice(price);
            crop.setDeliveryTime(deliveryTime);
            crop.setGrade(grade);
            crop.setDescription(description);

            // âœ… Store FULL Cloudinary URLs
            crop.setImages(imageUrls.toString());

            dao.saveCrop(crop);

            response.getWriter().write("{\"status\":\"SUCCESS\"}");

        } catch (Exception e) {
            e.printStackTrace();
            try {
                response.getWriter().write("{\"status\":\"FAILED\"}");
            } catch (Exception ignored) {}
        }
    }
}
