package com.agrolink.servlets;

import com.agrolink.db.DBConnection;
import com.google.gson.JsonObject;

import java.io.*;
import java.sql.*;
import java.util.UUID;
import javax.servlet.*;
import javax.servlet.annotation.MultipartConfig;
import javax.servlet.http.*;

@MultipartConfig(
        fileSizeThreshold = 1024 * 1024 * 2,
        maxFileSize = 1024 * 1024 * 15,
        maxRequestSize = 1024 * 1024 * 50
)
public class InsuranceApplyServlet extends BaseServlet {

    @Override
    protected void doPost(HttpServletRequest req, HttpServletResponse resp)
            throws ServletException, IOException {

        setCors(req, resp);
        resp.setContentType("application/json");
        PrintWriter out = resp.getWriter();

        try (Connection conn = DBConnection.getConnection()) {

            /* ------------------------------------------------------
               ⭐ READ farmerId FROM SESSION
            ------------------------------------------------------ */
            HttpSession session = req.getSession(false);
            String farmerId = (session != null) ? (String) session.getAttribute("farmerId") : null;

            if (farmerId == null || farmerId.trim().isEmpty()) {
                throw new RuntimeException("Farmer ID missing. Login required.");
            }

            /* ------------------------------------------------------
               Generate unique Insurance ID
            ------------------------------------------------------ */
            String insuranceId =
                    "INS-" + UUID.randomUUID().toString().substring(0, 8).toUpperCase();

            /* ------------------------------------------------------
               Read Text Fields
            ------------------------------------------------------ */
            String fullName = req.getParameter("fullName");
            String area = req.getParameter("area");
            String totalLandArea = req.getParameter("totalLandArea");
            String landOwnership = req.getParameter("landOwnership");
            String phone = req.getParameter("phone");
            String farmLocation = req.getParameter("farmLocation");
            String cropToInsure = req.getParameter("cropToInsure");
            String cropVariety = req.getParameter("cropVariety");
            String expectedSowing = req.getParameter("expectedSowing");
            String expectedHarvest = req.getParameter("expectedHarvest");
            String pastCropHistory = req.getParameter("pastCropHistory");
            String govIdNumber = req.getParameter("govIdNumber");
            String aadhaar = req.getParameter("aadhaar");
            String bankAccount = req.getParameter("bankAccount");
            String ifsc = req.getParameter("ifsc");
            String coverageType = req.getParameter("coverageType");

            /* ------------------------------------------------------
               File Upload
            ------------------------------------------------------ */
            String uploadPath = req.getServletContext().getRealPath("") + File.separator + "uploads";
            File uploadDir = new File(uploadPath);

            if (!uploadDir.exists()) uploadDir.mkdirs();

            String landDoc = saveFile(req.getPart("landDoc"), uploadPath);
            String idProof = saveFile(req.getPart("idProof"), uploadPath);
            String previousPolicy = saveFile(req.getPart("previousPolicy"), uploadPath);

            /* ------------------------------------------------------
               SQL Insert Query — MUST match table column names
            ------------------------------------------------------ */
            String sql = "INSERT INTO insurance_applications (" +
                    "insuranceId, farmerId, fullName, area, totalLandArea, landOwnership, phone, farmLocation, " +
                    "cropToInsure, cropVariety, expectedSowing, expectedHarvest, pastCropHistory, govIdNumber, aadhaar, " +
                    "bankAccount, ifsc, coverageType, landDoc, idProof, previousPolicy" +
                    ") VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)";

            PreparedStatement ps = conn.prepareStatement(sql);

            ps.setString(1, insuranceId);
            ps.setString(2, farmerId);
            ps.setString(3, fullName);
            ps.setString(4, area);
            ps.setString(5, totalLandArea);
            ps.setString(6, landOwnership);
            ps.setString(7, phone);
            ps.setString(8, farmLocation);
            ps.setString(9, cropToInsure);
            ps.setString(10, cropVariety);
            ps.setString(11, expectedSowing);
            ps.setString(12, expectedHarvest);
            ps.setString(13, pastCropHistory);
            ps.setString(14, govIdNumber);
            ps.setString(15, aadhaar);
            ps.setString(16, bankAccount);
            ps.setString(17, ifsc);
            ps.setString(18, coverageType);
            ps.setString(19, landDoc);
            ps.setString(20, idProof);
            ps.setString(21, previousPolicy);

            /* ------------------------------------------------------
               Execute Insert
            ------------------------------------------------------ */
            int result = ps.executeUpdate();

            JsonObject json = new JsonObject();

            if (result > 0) {
                json.addProperty("status", "SUCCESS");
                json.addProperty("insuranceId", insuranceId);
            } else {
                json.addProperty("status", "FAILED");
            }

            out.print(json.toString());

        } catch (Exception e) {
            e.printStackTrace();
            JsonObject error = new JsonObject();
            error.addProperty("status", "ERROR");
            error.addProperty("message", e.getMessage());
            out.print(error.toString());
        }
    }

    /* ------------------------------------------------------
       File Saver Helper Function
    ------------------------------------------------------ */
    private String saveFile(Part part, String uploadDir) throws IOException {
        if (part == null || part.getSubmittedFileName() == null || part.getSize() == 0)
            return "";

        String fileName = System.currentTimeMillis() + "_" + part.getSubmittedFileName();
        part.write(uploadDir + File.separator + fileName);

        return "uploads/" + fileName; // stored relative path
    }
}