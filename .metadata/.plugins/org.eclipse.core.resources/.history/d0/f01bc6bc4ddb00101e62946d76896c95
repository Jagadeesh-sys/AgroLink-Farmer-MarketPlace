import React, { useEffect, useState } from "react";
import { Link, useNavigate } from "react-router-dom";
import "../Css/Cart.css";
import Sidebar from "../components/Sidebar";
import Navbar from "../components/Navbar";
import Footer from "../components/Footer";

function Cart() {
  const [cart, setCart] = useState([]);
  const [user, setUser] = useState(null);
  const [discountCode, setDiscountCode] = useState("");
  const [discountPct, setDiscountPct] = useState(0);
  const navigate = useNavigate();

  /* =========================
     SAFE CART LOAD + MERGE
  ========================= */
  useEffect(() => {
    const refreshCart = () => {
      try {
        const raw = localStorage.getItem("cart");
        const parsed = raw ? JSON.parse(raw) : [];

        if (!Array.isArray(parsed)) {
          setCart([]);
          return;
        }

        // âœ… MERGE DUPLICATES SAFELY
        const merged = [];
        parsed.forEach((item) => {
          if (!item || !item.cropId) return;

          const found = merged.find(
            (m) => m.cropId === item.cropId
          );

          if (found) {
            found.qty += item.qty || 1;
          } else {
            merged.push({
              ...item,
              qty: item.qty || 1,
            });
          }
        });

        setCart(merged);
      } catch {
        setCart([]);
      }
    };

    refreshCart();
    window.addEventListener("focus", refreshCart);
    return () => window.removeEventListener("focus", refreshCart);
  }, []);

  /* =========================
     LOAD USER (SESSION)
  ========================= */
  useEffect(() => {
    fetch("/api/user/get-profile", { credentials: "include" })
      .then((res) => res.json())
      .then((data) => {
        if (!data || data.status === "error") return;
        setUser(data);
      })
      .catch(() => setUser(null));
  }, []);

  /* =========================
     CART HELPERS
  ========================= */
  const updateCart = (newCart) => {
    setCart(newCart);
    localStorage.setItem("cart", JSON.stringify(newCart));
    window.dispatchEvent(new Event("cartUpdated"));
  };

  const clearCart = () => updateCart([]);

  const updateKg = (cropId, enteredQty, availableQty) => {
    let qty = Number(enteredQty);
    if (qty < 1) qty = 1;
    if (qty > availableQty) qty = availableQty;

    updateCart(
      cart.map((item) =>
        item.cropId === cropId ? { ...item, qty } : item
      )
    );
  };

  const removeItem = (id) =>
    updateCart(cart.filter((c) => c.cropId !== id));

  const fmt = (n) => new Intl.NumberFormat("en-IN").format(n);

  const getImage = (imgStr) => {
    if (!imgStr) return process.env.PUBLIC_URL + "/Images/noimg.png";
    if (imgStr.startsWith("http") || imgStr.startsWith("data:")) return imgStr;
    const first = imgStr.split(",")[0].trim();
    return `http://localhost:9090/backend/uploads/${first}`;
  };

  /* =========================
     GST LOGIC
  ========================= */
  const getItemGST = (item) => {
    if (item.farmerId) return 0;
    if (item.cropId.startsWith("SEED")) return 0;
    if (item.cropId.startsWith("FERT")) return 0.05;
    if (item.cropId.startsWith("PEST")) return 0.18;
    return 0;
  };

  const categoryTotal = { crops: 0, seeds: 0, fert: 0, pest: 0 };
  const gstTotal = { crops: 0, seeds: 0, fert: 0, pest: 0 };

  cart.forEach((item) => {
    const amount = item.price * item.qty;
    const gstRate = getItemGST(item);

    if (item.farmerId) {
      categoryTotal.crops += amount;
      gstTotal.crops += amount * gstRate;
    } else if (item.cropId.startsWith("SEED")) {
      categoryTotal.seeds += amount;
      gstTotal.seeds += amount * gstRate;
    } else if (item.cropId.startsWith("FERT")) {
      categoryTotal.fert += amount;
      gstTotal.fert += amount * gstRate;
    } else if (item.cropId.startsWith("PEST")) {
      categoryTotal.pest += amount;
      gstTotal.pest += amount * gstRate;
    }
  });

  const subtotal =
    categoryTotal.crops +
    categoryTotal.seeds +
    categoryTotal.fert +
    categoryTotal.pest;

  const discountAmount = Math.round(subtotal * discountPct);
  const taxable = subtotal - discountAmount;

  const finalGST =
    Math.round(gstTotal.crops) +
    Math.round(gstTotal.seeds) +
    Math.round(gstTotal.fert) +
    Math.round(gstTotal.pest);

  const platformFee = 10;
  const deliveryCharge = 40;
  const grandTotal = taxable + finalGST + platformFee + deliveryCharge;

  const applyDiscount = () => {
    setDiscountPct(
      discountCode.trim().toUpperCase() === "SAVE10" ? 0.1 : 0
    );
  };

  return (
    <div className="dashboard-wrapper">
      <Sidebar cartCount={cart.length} />

      <div className="dashboard-content">
        <Navbar />

        <main className="dashboard-main">
          <div className="cart-header">
            <h2>Hello, {user?.fullName || "Guest"} ðŸ‘‹</h2>
            <p>Your shopping cart summary</p>
          </div>

          <div className="cart-layout">
            {/* LEFT */}
            <div className="cart-items">
              {cart.length === 0 ? (
                <p className="empty-cart">
                  Your cart is empty.{" "}
                  <Link to="/marketplace">Explore Marketplace</Link>
                </p>
              ) : (
                cart.map((item) => {
                  const available =
                    Number(item.availableStock ?? item.quantity) || 0;

                  return (
                    <div className="cart-card-pro" key={item.cropId}>
                      <img
                        src={getImage(item.images)}
                        alt={item.cropName}
                        className="cart-img-pro"
                      />

                      <div className="cart-details-pro">
                        <h3>{item.cropName}</h3>
                        <p>â‚¹{item.price}</p>

                        <div className="qty-box">
                          <button
                            onClick={() =>
                              updateKg(item.cropId, item.qty - 1, available)
                            }
                          >
                            -
                          </button>

                          <input
                            value={item.qty}
                            onChange={(e) =>
                              updateKg(
                                item.cropId,
                                e.target.value,
                                available
                              )
                            }
                          />

                          <button
                            onClick={() =>
                              updateKg(item.cropId, item.qty + 1, available)
                            }
                          >
                            +
                          </button>
                        </div>

                        <p>
                          Item Total: <b>â‚¹{fmt(item.price * item.qty)}</b>
                        </p>
                      </div>

                      <button
                        className="remove-btn-pro"
                        onClick={() => removeItem(item.cropId)}
                      >
                        Remove
                      </button>
                    </div>
                  );
                })
              )}
            </div>

            {/* RIGHT */}
            <div className="cart-summary-card">
              <h2>Order Summary</h2>

              <div className="summary-row">
                <span>Subtotal</span>
                <b>â‚¹{fmt(subtotal)}</b>
              </div>

              {discountAmount > 0 && (
                <div className="summary-row">
                  <span>Discount</span>
                  <b>-â‚¹{fmt(discountAmount)}</b>
                </div>
              )}

              <div className="summary-row">
                <span>GST</span>
                <b>â‚¹{fmt(finalGST)}</b>
              </div>

              <div className="summary-row">
                <span>Platform Fee</span>
                <b>â‚¹{platformFee}</b>
              </div>

              <div className="summary-row">
                <span>Delivery</span>
                <b>â‚¹{deliveryCharge}</b>
              </div>

              <hr />

              <div className="summary-row total">
                <span>Grand Total</span>
                <b>â‚¹{fmt(grandTotal)}</b>
              </div>

              <button
                className="checkout-btn-pro"
                disabled={cart.length === 0}
                onClick={() => navigate("/checkout")}
              >
                Proceed to Checkout
              </button>

              <div className="coupon-row">
                <input
                  placeholder="Discount code (SAVE10)"
                  value={discountCode}
                  onChange={(e) => setDiscountCode(e.target.value)}
                />
                <button onClick={applyDiscount}>Apply</button>
              </div>

              <button className="clear-cart-btn" onClick={clearCart}>
                Clear Cart
              </button>
            </div>
          </div>
        </main>

        <Footer />
      </div>
    </div>
  );
}

export default Cart;
