import React, { useEffect, useState } from "react";
import { Link } from "react-router-dom";
import "../Css/Dashboard.css";
import Sidebar from "../components/Sidebar";
import Navbar from "../components/Navbar";
import Footer from "../components/Footer";

function Dashboard() {
  const [user, setUser] = useState(null);
  const [crops, setCrops] = useState([]);
  const [editingCrop, setEditingCrop] = useState(null);
  const [cartCount, setCartCount] = useState(0);

  /* =========================
     LOAD USER + CROPS
  ========================= */
  useEffect(() => {
    fetch("/api/user/get-profile", { credentials: "include" })
      .then((res) => res.json())
      .then((data) => {
        if (data.status === "error") {
          window.location.href = "/login";
          return;
        }

        setUser(data);

        return fetch(
          `/api/crop/farmer?farmerId=${data.farmerId}`,
          { credentials: "include" }
        );
      })
      .then((res) => res?.json())
      .then((list) => setCrops(list || []))
      .catch(() => (window.location.href = "/login"));

    const cart = JSON.parse(localStorage.getItem("cart")) || [];
    setCartCount(cart.length);
  }, []);

  /* =========================
     IMAGE URL ‚Äì FINAL FIX
  ========================= */
  const getFirstImage = (images) => {
    if (!images) {
      return process.env.PUBLIC_URL + "/Images/noimg.png";
    }

    const firstImage = images.split(",")[0].trim();

    return `http://localhost:9090/backend/uploads/${firstImage}`;
  };

  /* =========================
     DELETE CROP
  ========================= */
  const deleteCrop = (cropId, images) => {
    if (!window.confirm("Delete this crop?")) return;

    fetch("/api/crop/delete", {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded",
      },
      body: `cropId=${cropId}&images=${encodeURIComponent(images || "")}`,
      credentials: "include",
    })
      .then((res) => res.json())
      .then((d) => {
        if (d.status === "SUCCESS") {
          setCrops((prev) =>
            prev.filter((c) => c.cropId !== cropId)
          );
        } else {
          alert("Delete failed");
        }
      });
  };

  /* =========================
     UPDATE CROP
  ========================= */
  const saveEdit = () => {
    const fd = new FormData();
    fd.append("cropId", editingCrop.cropId);
    fd.append("cropName", editingCrop.cropName);
    fd.append("category", editingCrop.category);
    fd.append("quantity", editingCrop.quantity);
    fd.append("price", editingCrop.price);
    fd.append("description", editingCrop.description);

    fetch("/api/crop/update", {
      method: "POST",
      body: fd,
      credentials: "include",
    })
      .then((res) => res.json())
      .then((d) => {
        if (d.status === "SUCCESS") {
          setCrops((prev) =>
            prev.map((c) =>
              c.cropId === editingCrop.cropId ? editingCrop : c
            )
          );
          setEditingCrop(null);
        } else {
          alert("Update failed");
        }
      });
  };

  return (
    <>
      <Navbar />

      <div className="layout">
        <Sidebar cartCount={cartCount} />

        <div className="content-area">
          <main className="page-content">

            <header className="top-header">
              <div>
                <h2>Welcome, {user?.fullName} üëã</h2>
                <p>Your farming insights and performance summary</p>
              </div>
            </header>

            {/* ‚ö†Ô∏è NOT CHANGED AS REQUESTED */}
            <section className="stats-container">
              <div className="stat-card">
                <h3>{crops.length}</h3>
                <p>Total Crops Listed</p>
              </div>
            </section>

            <section className="crop-table-section">
              <h3>Your Crop Listings</h3>

              <table className="crop-table">
                <thead>
                  <tr>
                    <th>Image</th>
                    <th>Crop ID</th>
                    <th>Crop</th>
                    <th>Category</th>
                    <th>Qty</th>
                    <th>Price</th>
                    <th>Actions</th>
                  </tr>
                </thead>

                <tbody>
                  {crops.length === 0 ? (
                    <tr>
                      <td colSpan="7" className="no-data">
                        No crops posted yet.
                        <br />
                        <Link to="/marketplace/sell">Go to Sell</Link>
                      </td>
                    </tr>
                  ) : (
                    crops.map((c) => (
                      <tr key={c.cropId}>
                        <td>
                          <img
                            src={getFirstImage(c.images)}
                            className="crop-img"
                            alt="crop"
                            onError={(e) => {
                              e.target.onerror = null;
                              e.target.src =
                                process.env.PUBLIC_URL + "/Images/noimg.png";
                            }}
                          />
                        </td>

                        <td>{c.cropId}</td>
                        <td>{c.cropName}</td>
                        <td>{c.category}</td>
                        <td>{c.quantity} kg</td>
                        <td>‚Çπ{c.price}</td>

                        <td className="action-btns">
                          <button
                            className="edit-btn"
                            onClick={() => setEditingCrop(c)}
                          >
                            <i className="fa-solid fa-pen-to-square"></i>
                          </button>

                          <button
                            className="delete-btn"
                            onClick={() => deleteCrop(c.cropId, c.images)}
                          >
                            <i className="fa-solid fa-trash"></i>
                          </button>
                        </td>
                      </tr>
                    ))
                  )}
                </tbody>
              </table>
            </section>

          </main>

          <Footer />
        </div>
      </div>

      {editingCrop && (
        <div className="edit-popup">
          <div className="edit-box">
            <h2>Edit Crop</h2>

            <input
              value={editingCrop.cropName}
              onChange={(e) =>
                setEditingCrop({
                  ...editingCrop,
                  cropName: e.target.value,
                })
              }
            />

            <button onClick={saveEdit}>Save</button>
            <button onClick={() => setEditingCrop(null)}>Cancel</button>
          </div>
        </div>
      )}
    </>
  );
}

export default Dashboard;
