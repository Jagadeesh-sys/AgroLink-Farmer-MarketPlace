import React, { useState } from "react";
import { useNavigate } from "react-router-dom";
import Navbar from "../components/Navbar";
import Sidebar from "../components/Sidebar";
import Footer from "../components/Footer";
import "../Css/MyOrders.css";

function MyOrders() {
  const navigate = useNavigate();

  const [orders, setOrders] = useState(
    JSON.parse(localStorage.getItem("orders")) || []
  );

  /* =========================
     IMAGE HANDLER
  ========================= */
  const getImage = (imgStr) => {
    if (!imgStr) return "/Images/noimg.png";
    if (imgStr.startsWith("http") || imgStr.startsWith("data:")) return imgStr;
    const first = imgStr.split(",")[0].trim();
    return `http://localhost:9090/backend/uploads/${first}`;
  };

  /* =========================
     CANCEL ORDER
  ========================= */
  const cancelOrder = (orderId) => {
    const confirmCancel = window.confirm(
      "Are you sure you want to cancel this order?"
    );
    if (!confirmCancel) return;

    const updatedOrders = orders.map((order) =>
      order.orderId === orderId
        ? { ...order, status: "Cancelled" }
        : order
    );

    setOrders(updatedOrders);
    localStorage.setItem("orders", JSON.stringify(updatedOrders));
  };

  return (
    <>
      <Navbar />

      <div className="layout">
        <Sidebar cartCount={0} />

        <div className="orders-content">
          <main className="orders-main">
            <header className="orders-header">
              <h2>My Orders</h2>
              <p>View, track or cancel your orders</p>
            </header>

            {orders.length === 0 ? (
              <div className="orders-empty">
                You have not placed any orders yet.
              </div>
            ) : (
              <div className="orders-list">
                {orders.map((order) => (
                  <div className="order-card" key={order.orderId}>
                    {/* TOP */}
                    <div className="order-top">
                      <div>
                        <b>Order ID:</b> {order.orderId}
                      </div>

                      <span
                        className={`order-status ${
                          order.status === "Cancelled"
                            ? "status-cancelled"
                            : ""
                        }`}
                      >
                        {order.status}
                      </span>
                    </div>

                    {/* META */}
                    <div className="order-meta">
                      <span>
                        <b>Date:</b>{" "}
                        {new Date(order.date).toLocaleString()}
                      </span>
                      <span>
                        <b>Payment:</b>{" "}
                        {order.payment?.toUpperCase() || "COD"}
                      </span>
                    </div>

                    {/* ITEMS */}
                    <div className="order-items">
                      {order.items.slice(0, 3).map((item) => (
                        <div className="order-item-row" key={item.cropId}>
                          <img
                            src={getImage(item.images)}
                            alt={item.cropName}
                            className="order-item-img"
                          />

                          <div className="order-item-info">
                            <div className="order-item-name">
                              {item.cropName}
                            </div>
                            <div className="order-item-meta">
                              {item.qty} × ₹{item.price}
                            </div>
                          </div>
                        </div>
                      ))}

                      {order.items.length > 3 && (
                        <div className="more-items">
                          +{order.items.length - 3} more items
                        </div>
                      )}
                    </div>

                    {/* FOOTER */}
                    <div className="order-footer">
                      <div className="order-total">
                        ₹{order.total}
                      </div>

                      <div className="order-actions">
                        <button
                          className="track-btn"
                          onClick={() =>
                            navigate(`/orders/${order.orderId}`)
                          }
                        >
                          Track Order
                        </button>

                        {order.status !== "Cancelled" && (
                          <button
                            className="cancel-btn"
                            onClick={() => cancelOrder(order.orderId)}
                          >
                            Cancel
                          </button>
                        )}
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </main>

          <Footer />
        </div>
      </div>
    </>
  );
}

export default MyOrders;
