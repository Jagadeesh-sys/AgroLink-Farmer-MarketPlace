import React, { useEffect, useState } from "react";
import "../Css/MyCrops.css";
import Navbar from "../components/Navbar";
import Sidebar from "../components/Sidebar";
import Footer from "../components/Footer";

function MyCrops() {
  const [crops, setCrops] = useState([]);

  /* =========================
     LOAD USER + CROPS (SESSION)
  ========================= */
  useEffect(() => {
    fetch("/api/user/get-profile", {
      credentials: "include",
    })
      .then((res) => res.json())
      .then((data) => {
        if (!data || data.status === "error") {
          window.location.href = "/login";
          return;
        }

        return fetch(
          `/api/crop/farmer?farmerId=${data.farmerId}`,
          { credentials: "include" }
        );
      })
      .then((res) => res?.json())
      .then((list) => setCrops(list || []))
      .catch(() => console.error("My crops load error"));
  }, []);

  /* =========================
     IMAGE FIX
  ========================= */
  const getImage = (images) => {
    if (!images) {
      return process.env.PUBLIC_URL + "/Images/noimg.png";
    }

    const first = images.split(",")[0].trim();
    return `http://localhost:9090/backend/uploads/${first}`;
  };

  return (
    <>
      <Navbar />

      <div className="layout">
        <Sidebar cartCount={0} />

        <div className="content-area">
          <main className="page-crops">
            <h2>ðŸŒ± My Crops</h2>
            <p className="subtitle">Manage and monitor your crop listings</p>

            <div className="crops-list">
              {crops.length === 0 ? (
                <p>No crops added yet.</p>
              ) : (
                crops.map((crop) => (
                  <div key={crop.cropId} className="crop-card">
                    <img
                      src={getImage(crop.images)}
                      className="crop-img"
                      alt="crop"
                      onError={(e) => {
                        e.target.onerror = null;
                        e.target.src =
                          process.env.PUBLIC_URL + "/Images/noimg.png";
                      }}
                    />

                    <h3>{crop.cropName}</h3>
                    <p>Category: {crop.category}</p>
                    <p>Quantity: {crop.quantity} Kg</p>
                    <p>Price: â‚¹{crop.price}</p>
                  </div>
                ))
              )}
            </div>
          </main>

          <Footer />
        </div>
      </div>
    </>
  );
}

export default MyCrops;
