package com.agrolink.servlets;

import com.agrolink.dao.CropDAO;
import com.agrolink.model.Crop;

import javax.servlet.ServletException;
import javax.servlet.annotation.MultipartConfig;
import javax.servlet.http.*;
import java.io.File;
import java.io.IOException;
import java.util.Collection;

@MultipartConfig(
    fileSizeThreshold = 1024 * 1024,
    maxFileSize = 1024 * 1024 * 5,
    maxRequestSize = 1024 * 1024 * 20
)
public class SellingCropServlet extends BaseServlet {

    @Override
    protected void doPost(HttpServletRequest request, HttpServletResponse response)
            throws IOException, ServletException {

        setCors(request, response);
        response.setContentType("application/json");
        response.setCharacterEncoding("UTF-8");

        // ✅ CORRECT upload path
        String uploadPath = request.getServletContext().getRealPath("/uploads/");
        File uploadDir = new File(uploadPath);
        if (!uploadDir.exists()) {
            uploadDir.mkdirs();
            System.out.println("Created folder: " + uploadDir.getAbsolutePath());
        }

        String farmerId = request.getParameter("farmerId");
        String cropName = request.getParameter("cropName");
        String category = request.getParameter("category");
        String quantity = request.getParameter("quantity");
        String price = request.getParameter("price");
        String deliveryTime = request.getParameter("deliveryTime");
        String grade = request.getParameter("grade");
        String description = request.getParameter("description");

        StringBuilder imagesList = new StringBuilder();

        try {
            Collection<Part> parts = request.getParts();

            for (Part part : parts) {
                if (!"images".equals(part.getName())) continue;
                if (part.getSize() == 0) continue;

                String original = part.getSubmittedFileName();
                if (original == null || original.trim().isEmpty()) continue;

                // ✅ Safe filename
                String fileName = System.currentTimeMillis() + "_" +
                        original.replaceAll("[^a-zA-Z0-9._-]", "_");

                File file = new File(uploadDir, fileName);
                part.write(file.getAbsolutePath());

                imagesList.append(fileName).append(",");
            }

            Crop crop = new Crop();
            CropDAO dao = new CropDAO();

            String cropId = dao.generateCropId(farmerId);

            crop.setCropId(cropId);
            crop.setFarmerId(farmerId);
            crop.setCropName(cropName);
            crop.setCategory(category);
            crop.setQuantity(quantity);
            crop.setPrice(price);
            crop.setDeliveryTime(deliveryTime);
            crop.setGrade(grade);
            crop.setDescription(description);

            // ✅ store only filenames
            crop.setImages(imagesList.toString());

            dao.saveCrop(crop);

            sendJson(response, "{\"status\":\"SUCCESS\"}");

        } catch (Exception e) {
            e.printStackTrace();
            sendJson(response, "{\"status\":\"FAILED\"}");
        }
    }
}
